pipeline {
  agent {
      node {
        label 'master-node'
      }
    }
  options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        skipDefaultCheckout()
    }
  stages {
    stage('checkout sources') {
      steps {
        sh 'docker-compose down || true'
        sh 'sudo git reset --hard || true'
        sh 'sudo git clean -fdx || true'
        checkout scm
      }
    }
    stage('build') {
      steps {
        sh 'cp docker-compose.override.yml.example docker-compose.override.yml'
        sh 'docker-compose build'
      }
    }
    stage('deploy') {
      steps {
        sh 'docker-compose up -d'
      }
    }
    stage('code-quality') {
      steps {
        sh 'docker-compose exec -T runner-api mvn checkstyle:check'
      }
    }
    stage('test'){
        parallel {
            stage('API') {
              steps {
                sh 'docker-compose exec -T runner-api mvn compile test "-Dcucumber.options=--tags @UnitTest --tags @HttpManagerTest"'
              }
            }
            stage('Chrome') {
              steps {
                sh 'docker-compose exec -T runner-chrome mvn compile test "-Dcucumber.options=--tags @UnitTest --tags @InternalSeleniumTest"'
              }
            }
            stage('Firefox') {
              steps {
                sh 'echo docker-compose exec -T runner-firefox mvn compile test "-Dcucumber.options=--tags @UnitTest --tags @InternalSeleniumTest"'
              }
            }
        }
    }
  }
  post {
     always {
        sh 'docker-compose down'
        sh 'sudo chmod -R o+xw ./build/allure-results || true'

        allure includeProperties: false, jdk: '', results: [[path: 'build/allure-results']]

        cleanWs()
      }
     failure {
       slackSend channel: 'qa-framework-ci', color: '#E01563', failOnError: true, message: "Job: ${env.JOB_NAME}, build number: ${env.BUILD_NUMBER}, Test Failed! Allure Report:  http://qa-server.catena.media/jenkins/job/QA-TestFramework/job/QA-Automation_Runner/job/${BRANCH_NAME}/${BUILD_NUMBER}/allure/", teamDomain: 'catenamedia', token: 't9anJ8Bh009cxHAiqM8RApGk'
     }
     success {        
        recordIssues aggregatingResults: true, enabledForFailure: true, tools: [checkStyle(), java()]
        slackSend channel: 'qa-framework-ci', color: '#3EB991', failOnError: true, message: "Job: ${env.JOB_NAME}, build number: ${env.BUILD_NUMBER}, Test Passed! Allure Report:  http://qa-server.catena.media/jenkins/job/QA-TestFramework/job/QA-Automation_Runner/job/${BRANCH_NAME}/${BUILD_NUMBER}/allure/", teamDomain: 'catenamedia', token: 't9anJ8Bh009cxHAiqM8RApGk'
     }
  }
}
